---
table: addresses

#############
# relations #
#############
object_relationships:
  - name: company
    using:
      manual_configuration:
        column_mapping:
          id: physical_address_id
        remote_table: companies
  - name: profile
    using:
      manual_configuration:
        column_mapping:
          id: address_id
        remote_table: profiles
  - name: provider_location
    using:
      manual_configuration:
        column_mapping:
          id: address_id
        remote_table: provider_locations

###############
# permissions #
###############
# insert_permissions:
#   - role: company-admin
#     permission:
#       columns: &insert_permissions:company-admin:permission:columns
#         - street
#         - city
#         - country
#         - latitude
#         - longitude
#         - state
#         - zip
#   - role: member
#     permission:
#       check:
#         _exists:
#           _table: patients
#           _where:
#             id:
#               _eq: X-Hasura-Member-Id
#             is_configuration_up_to_member:
#               _eq: true
#       columns: *insert_permissions:company-admin:permission:columns
#   - role: support
#     permission:
#       columns: *insert_permissions:company-admin:permission:columns
# select_permissions:
#   - role: company-admin
#     permission: &select_permissions:company-admin:permission
#       allow_aggregations: false
#       columns: &select_permissions:company-admin:permission:columns
#         - *insert_permissions:company-admin:permission:columns
#         - created_at
#         - id
#         - updated_at
#       filter: &select_permissions:company-admin:permission:filter
#         _and:
#           - &is-not-deleted
#             deleted_at:
#               _is_null: true
#           - _or:
#               # address from (super)admin of a company I'm an admin of
#               - company:
#                   id:
#                     _in: X-Hasura-Companies
#               # address of my user
#               - profile:
#                   user:
#                     id:
#                       _eq: X-Hasura-User-Id
#               # member is employee of company I'm an admin of
#               - profile:
#                   member: &company-im-an-admin-of
#                     company_id:
#                       _in: X-Hasura-Companies
#               # member is employee of a company I'm a broker of
#               - profile:
#                   member: &company-im-a-broker-of
#                     company:
#                       broker_id:
#                         _in: X-Hasura-Companies
#               # TODO cleanup if provider role works
#               # # member goes to a location of a company I'm an admin of
#               # # this covers the professional too
#               # - profile:
#               #     member:
#               #       provider_location: *company-im-an-admin-of
#               # member is related to an employee of a company I'm an admin of
#               - profile:
#                   member:
#                     main_member: *company-im-an-admin-of
#               # member is related to an employee of a company I'm a broker of
#               - profile:
#                   member:
#                     main_member: *company-im-a-broker-of
#               # TODO cleanup if provider role works
#               # # main member goes to a location of a company I'm an admin of
#               # # this covers the professional too
#               # - profile:
#               #     member:
#               #       provider_location: *company-im-an-admin-of
#               - provider_location: *company-im-an-admin-of
#   - role: company-user
#     permission: *select_permissions:company-admin:permission
#   - role: public
#     permission:
#       allow_aggregations: false
#       columns:
#         - *insert_permissions:company-admin:permission:columns
#         - id
#       filter:
#         _and:
#           - *is-not-deleted
#           # only provider locations addresses are public
#           - &has-provider-locations
#             provider_location:
#               id:
#                 _is_null: false
#   - role: member
#     permission:
#       allow_aggregations: false
#       columns: *select_permissions:company-admin:permission:columns
#       filter: &select_permissions:member:permission:filter
#         _and:
#           - *is-not-deleted
#           - _or:
#               - profile:
#                   member:
#                     id:
#                       _eq: X-Hasura-Member-Id
#               - profile:
#                   member:
#                     main_member_id:
#                       _eq: X-Hasura-Member-Id
#               - *has-provider-locations
#   - role: support
#     permission:
#       allow_aggregations: false
#       columns:
#         - *select_permissions:company-admin:permission:columns
#         - deleted_at
#   - role: provider
#     permission:
#       allow_aggregations: false
#       columns:
#         - id
#         - street
#         - city
#         - country
#         - state
#         - zip
#       filter:
#         _and:
#           - *is-not-deleted
#           - _or:
#             # member goes to a location of a company I'm an admin of
#             # this covers the professional too
#             - profile:
#                 member:
#                   provider_location: *company-im-an-admin-of
#             # - profile:
#             #     member:
#             #       related_patients:
#             #         provider_location: *company-im-an-admin-of
# update_permissions:
#   - role: company-admin
#     permission:
#       columns: &update_permissions:company-admin:permission:columns
#         - *insert_permissions:company-admin:permission:columns
#         - deleted_at
#       filter: *select_permissions:company-admin:permission:filter
#   - role: member
#     permission:
#       columns: *update_permissions:company-admin:permission:columns
#       filter: *select_permissions:member:permission:filter
#   - role: support
#     permission:
#       columns: *update_permissions:company-admin:permission:columns

############
#  events  #
############
# event_triggers:
#   - name: geocode-address
#     definition:
#       enable_manual: true
#       insert:
#         columns: '*'
#       update:
#         columns:
#           - zip
#           - country
#           - street
#           - city
#           - state
#     headers:
#       - name: x-api-key
#         value_from_env: HASURA_EVENTS_KEY
#     retry_conf:
#       interval_sec: 10
#       num_retries: 0
#       timeout_sec: 60
#     webhook_from_env: HASURA_EVENTS_URL
