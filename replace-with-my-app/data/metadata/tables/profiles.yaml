---
table: profiles

#############
# relations #
#############
object_relationships:
  - name: address
    using:
      foreign_key_constraint_on: address_id
  - name: user
    using:
      manual_configuration:
        column_mapping:
          id: profile_id
        remote_table: users
  - name: patient
    using:
      manual_configuration:
        column_mapping:
          id: profile_id
        remote_table: patients

###############
# permissions #
###############
# insert_permissions:
#   - role: company-admin
#     permission:
#       columns: &insert_permissions:company-admin:permission:columns
#         - address_id
#         - date_of_birth
#         - first_name
#         - gender
#         - last_name
#         - marital_status
#         - signature
#         - social_security_number
#         - title
#   - role: member
#     permission:
#       check:
#         _exists:
#           _table: patients
#           _where:
#             id:
#               _eq: X-Hasura-Member-Id
#             is_configuration_up_to_member:
#               _eq: true
#       columns: *insert_permissions:company-admin:permission:columns
#   - role: support
#     permission:
#       columns: *insert_permissions:company-admin:permission:columns
# select_permissions:
#   - role: company-admin
#     permission: &select_permissions:company-admin:permission
#       allow_aggregations: true
#       columns: &select_permissions:company-admin:permission:columns
#         - *insert_permissions:company-admin:permission:columns
#         - created_at
#         - id
#         - updated_at
#       filter:
#         _and:
#           - &is-not-deleted
#             deleted_at:
#               _is_null: true
#           - _or:
#               # profile of current user
#               - user:
#                   id:
#                     _eq: X-Hasura-User-Id
#               # profile of user from (super)admin of a company I'm an admin of
#               - user:
#                   company_users:
#                     &company-im-an-admin-of
#                     company_id:
#                       _in: X-Hasura-Companies
#               # profile of user from (super)admin of a company I'm a broker of
#               - user:
#                   company_users:
#                     &company-im-a-broker-of
#                     company:
#                       broker_id:
#                         _in: X-Hasura-Companies
#               # profile of professional of a location I'm an admin of
#               # this covers the professional too
#               - user:
#                   professional:
#                     professional_locations:
#                       provider_location: *company-im-an-admin-of
#               # member is employee of company I'm an admin of
#               - member: *company-im-an-admin-of
#               # member is employee of a company I'm a broker of
#               - member: *company-im-a-broker-of
#               # TODO cleanup if provider role works
#               # # member goes to a location of a company I'm an admin of
#               # # this covers the professional too
#               # - member:
#               #     provider_location: *company-im-an-admin-of
#               # member is related to an employee of a company I'm an admin of
#               - member:
#                   main_member: *company-im-an-admin-of
#               # member is related to an employee of a company I'm a broker of
#               - member:
#                   main_member: *company-im-a-broker-of
#               # TODO cleanup if provider role works
#               # # related member goes to a location of a company I'm an admin of
#               # # this covers the professional too
#               # - member:
#               #     provider_location: *company-im-an-admin-of
#   - role: company-user
#     permission: *select_permissions:company-admin:permission
#   - role: public
#     permission:
#       allow_aggregations: false
#       columns:
#         - first_name
#         - id
#         - last_name
#         - title
#       filter:
#         _and:
#           - *is-not-deleted
#           # is a professional
#           - &is-professional
#             user:
#               professional:
#                 id:
#                   _is_null: false
#   - role: member
#     permission:
#       allow_aggregations: true
#       columns: *select_permissions:company-admin:permission:columns
#       filter: &select_permissions:member:permission:filter
#         _and:
#           - *is-not-deleted
#           - _or:
#               # profile of current user
#               - user:
#                   id:
#                     _eq: X-Hasura-User-Id
#               - member:
#                   main_member_id:
#                     _eq: X-Hasura-Member-Id
#               - *is-professional
#   - role: support
#     permission:
#       allow_aggregations: true
#       columns:
#         - *select_permissions:company-admin:permission:columns
#         - deleted_at
#   - role: verifier
#     permission:
#       allow_aggregations: false
#       columns:
#         - first_name
#         - last_name
#         - date_of_birth
#       filter: *is-not-deleted
#       limit: 1
#   - role: provider
#     permission:
#       allow_aggregations: false
#       columns: *select_permissions:company-admin:permission:columns
#       filter:
#         _and:
#           - *is-not-deleted
#           - _or:
#             # profile of professional of a location I'm an admin of
#             # this covers the professional too
#             - user:
#                 professional:
#                   professional_locations:
#                     provider_location: *company-im-an-admin-of
#             # related member goes to a location of a company I'm an admin of
#             # this covers the professional too
#             - member:
#                 provider_location: *company-im-an-admin-of
#             # # is main member of a member that chose us
#             # - member:
#             #     related_patients:
#             #       provider_location: *company-im-an-admin-of
# update_permissions:
#   - role: company-admin
#     permission:
#       columns: &update_permissions:company-admin:permission:columns
#         - *select_permissions:company-admin:permission:columns
#         - deleted_at
#       filter:
#         _and:
#           - *is-not-deleted
#           - _or:
#               # profile of current user
#               - user:
#                   id:
#                     _eq: X-Hasura-User-Id
#               # profile of user from (super)admin of a company I'm an admin of
#               - user:
#                   company_users:
#                     &company-im-an-admin-of
#                     company_id:
#                       _in: X-Hasura-Companies
#               # profile of user from (super)admin of a company I'm a broker of
#               - user:
#                   company_users:
#                     &company-im-a-broker-of
#                     company:
#                       broker_id:
#                         _in: X-Hasura-Companies
#               # profile of professional of a location I'm an admin of
#               # this covers the professional too
#               - user:
#                   professional:
#                     professional_locations:
#                       provider_location: *company-im-an-admin-of
#               # member is employee of company I'm an admin of
#               - member: *company-im-an-admin-of
#               # member is employee of a company I'm a broker of
#               - member: *company-im-a-broker-of
#               # member is related to an employee of a company I'm an admin of
#               - member:
#                   main_member: *company-im-an-admin-of
#               # member is related to an employee of a company I'm a broker of
#               - member:
#                   main_member: *company-im-a-broker-of
#   - role: member
#     permission:
#       columns: *select_permissions:company-admin:permission:columns
#       filter: *select_permissions:member:permission:filter
#   - role: support
#     permission:
#       columns: *update_permissions:company-admin:permission:columns
