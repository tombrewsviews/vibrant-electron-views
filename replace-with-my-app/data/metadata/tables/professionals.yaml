---
table: professionals

#############
# relations #
#############
array_relationships:
  - name: professional_locations
    using:
      foreign_key_constraint_on:
        column: professional_id
        table: professional_locations
  - name: patients
    using:
      foreign_key_constraint_on:
        column: professional_id
        table: patients
object_relationships:
  - name: license
    using:
      foreign_key_constraint_on: license_id
  - name: user
    using:
      foreign_key_constraint_on: user_id

###############
# permissions #
###############
# insert_permissions:
#   - role: company-admin
#     permission: &insert_permissions:company-admin:permission
#       columns: &insert_permissions:company-admin:permission:columns
#         - license_custom_age_max
#         - license_custom_age_min
#         - license_id
#         - license_number
#         - national_provider_id
#         - user_id
#         - is_accepting_new_patients
#   - role: support
#     permission: *insert_permissions:company-admin:permission
# select_permissions:
#   - role: company-admin
#     permission: &select_permissions:company-admin:permission
#       allow_aggregations: true
#       columns: &select_permissions:company-admin:permission:columns
#         - *insert_permissions:company-admin:permission:columns
#         - created_at
#         - id
#         - updated_at
#       computed_fields:
#         &select_permissions:company-admin:permission:computed_fields
#         - full_name
#         - full_name_and_license
#       # TODO see this permission in the context of an admin choosing the
#       # location/professional for an employee. If we extend on this permission
#       # in a sensible way we will be able to keep on using the company-admin
#       # role instead of having to swap roles in the UI.
#       # If we were to change them, we'd need to restrict the update_permissions
#       # below
#       filter: &select_permissions:company-admin:permission:filter
#         _and:
#           - deleted_at:
#               _is_null: true
#           - _or:
#               # professional of a company I'm an admin of
#               - professional_locations:
#                   provider_location:
#                     company_id:
#                       _in: X-Hasura-Companies
#               # professional is the current user
#               - user_id:
#                   _eq: X-Hasura-User-Id
#   - role: company-user
#     permission: *select_permissions:company-admin:permission
#   - role: member
#     permission:
#       allow_aggregations: true
#       columns: *select_permissions:company-admin:permission:columns
#       computed_fields: *select_permissions:company-admin:permission:computed_fields
#       filter: &select_permissions:member:permission:filter
#         _and:
#           - deleted_at:
#               _is_null: true
#           # only expose locations for providers that have accepted the agreement
#           - professional_locations:
#               provider_location:
#                 company:
#                   company_agreements:
#                     type:
#                       _eq: Provider
#                     has_accepted_agreement:
#                       _eq: true
#   - role: provider
#     permission: *select_permissions:company-admin:permission
#   - role: public
#     permission:
#       columns:
#         - *insert_permissions:company-admin:permission:columns
#         - id
#       computed_fields: *select_permissions:company-admin:permission:computed_fields
#       filter: *select_permissions:member:permission:filter
#   - role: support
#     permission:
#       columns:
#         - *select_permissions:company-admin:permission:columns
#         - deleted_at
#       computed_fields: *select_permissions:company-admin:permission:computed_fields
# update_permissions:
#   - role: company-admin
#     permission:
#       columns: &update_permissions:company-admin:permission:columns
#         - *insert_permissions:company-admin:permission:columns
#         - deleted_at
#       filter: *select_permissions:company-admin:permission:filter
#   - role: support
#     permission:
#       columns: *update_permissions:company-admin:permission:columns

###################
# computed fieldsÂ #
###################
computed_fields:
  - name: full_name
    table:
      name: professionals
      schema: public
    definition:
      function:
        name: professionals_full_name
        schema: public
      table_argument: professional
  - name: full_name_and_license
    table:
      name: professionals
      schema: public
    definition:
      function:
        name: professionals_full_name_and_license
        schema: public
      table_argument: professional
