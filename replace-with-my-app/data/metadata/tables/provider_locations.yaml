---
table: provider_locations

#############
# relations #
#############
array_relationships:
  - name: professional_locations
    using:
      foreign_key_constraint_on:
        column: provider_location_id
        table: professional_locations
  - name: patients
    using:
      foreign_key_constraint_on:
        column: provider_location_id
        table: patients
object_relationships:
  - name: address
    using:
      foreign_key_constraint_on: address_id
  - name: company
    using:
      foreign_key_constraint_on: company_id
  - name: company_doing_business_as
    using:
      foreign_key_constraint_on: company_doing_business_as_id

###############
# permissions #
###############
# insert_permissions:
#   - role: company-admin
#     permission:
#       check: &company-im-an-admin-of
#         company_id:
#           _in: X-Hasura-Companies
#       columns: &insert_permissions:company-admin:permission:columns
#         - address_id
#         - company_doing_business_as_id
#         - company_id
#         - phone_number
#         - website
#   - role: support
#     permission:
#       columns: *insert_permissions:company-admin:permission:columns
# select_permissions:
#   - role: company-admin
#     permission: &select_permissions:company-admin:permission
#       allow_aggregations: true
#       columns: &select_permissions:company-admin:permission:columns
#         - *insert_permissions:company-admin:permission:columns
#         - created_at
#         - id
#         - updated_at
#       computed_fields:
#         &select_permissions:company-admin:permission:computed_fields
#         - doing_business_as_and_address
#       filter: &select_permissions:company-admin:permission:filter
#         _and:
#           - &is-not-deleted
#             deleted_at:
#               _is_null: true
#           - *company-im-an-admin-of
#   - role: company-user
#     permission: *select_permissions:company-admin:permission
#   - role: member
#     permission:
#       allow_aggregations: true
#       columns: *select_permissions:company-admin:permission:columns
#       computed_fields: *select_permissions:company-admin:permission:computed_fields
#       filter: &select_permissions:member:permission:filter
#         _and:
#           - *is-not-deleted
#           # only expose locations for providers that have accepted the agreement
#           - company:
#               company_agreements:
#                 type:
#                   _eq: Provider
#                 has_accepted_agreement:
#                   _eq: true
#   - role: public
#     permission:
#       allow_aggregations: true
#       columns:
#         - *insert_permissions:company-admin:permission:columns
#         - id
#       computed_fields: *select_permissions:company-admin:permission:computed_fields
#       filter: *select_permissions:member:permission:filter
#   - role: support
#     permission:
#       allow_aggregations: true
#       columns:
#         - *select_permissions:company-admin:permission:columns
#         - deleted_at
#       computed_fields: *select_permissions:company-admin:permission:computed_fields
#   - role: provider
#     permission: *select_permissions:company-admin:permission
# update_permissions:
#   - role: company-admin
#     permission:
#       columns: &update_permissions:company-admin:permission:columns
#         - *select_permissions:company-admin:permission:columns
#         - deleted_at
#       filter: *select_permissions:company-admin:permission:filter
#   - role: support
#     permission:
#       columns: *update_permissions:company-admin:permission:columns

###################
# computed fieldsÂ #
###################
computed_fields:
  - name: doing_business_as_and_address
    table:
      name: provider_locations
      schema: public
    definition:
      function:
        name: provider_locations_doing_business_as_and_address
        schema: public
      table_argument: provider_location
